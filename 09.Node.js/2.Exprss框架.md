## 9. Express

### 9.1 Express ä»‹ç»

â€‹	Express æ˜¯ä¸€ä¸ªåŸºäº Node.js å¹³å°çš„æç®€ã€çµæ´»çš„ WEB åº”ç”¨å¼€å‘æ¡†æ¶ï¼Œå®˜æ–¹ç½‘å€ï¼š` https://www.expressjs.com.cn/`
â€‹	ç®€å•æ¥è¯´ï¼Œexpress æ˜¯ä¸€ä¸ªå°è£…å¥½çš„å·¥å…·åŒ…ï¼Œå°è£…äº†å¾ˆå¤šåŠŸèƒ½ï¼Œä¾¿äºæˆ‘ä»¬å¼€å‘ WEB åº”ç”¨ï¼ˆHTTP æœåŠ¡ï¼‰



### 9.2 express ä½¿ç”¨

#### 9.2.1 åˆä½“éªŒ

- ä¸‹è½½

```js
express æœ¬èº«æ˜¯ä¸€ä¸ª npm åŒ…ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ npm å®‰è£…
npm init
npm i express
```

- jsä»£ç 

```js
var express = require('express');

//åˆ›å»ºåº”ç”¨
var app = express();

//åˆ›å»ºè·¯ç”±è§„åˆ™
app.get('/home',(req,res)=>{
    console.log('æœ‰äººè¯·æ±‚æœåŠ¡å™¨1äº†');
    res.end('hello express server');
});

// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000,()=>{
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})
```

- å¯åŠ¨

```js
`node <æ–‡ä»¶å>`
# æˆ–è€…
`nodemon <æ–‡ä»¶å>`
```

- ç„¶ååœ¨æµè§ˆå™¨å°±å¯ä»¥è®¿é—® http://127.0.0.1:3000/home ğŸ‘Œ

  

#### 9.2.2 express è·¯ç”±

```html
å®˜æ–¹å®šä¹‰ï¼š è·¯ç”±ç¡®å®šäº†åº”ç”¨ç¨‹åºå¦‚ä½•å“åº”å®¢æˆ·ç«¯å¯¹ç‰¹å®šç«¯ç‚¹çš„è¯·æ±‚
ä¸€ä¸ªè·¯ç”±çš„ç»„æˆæœ‰ è¯·æ±‚æ–¹æ³• ï¼Œ è·¯å¾„ å’Œ å›è°ƒå‡½æ•° ç»„æˆ
express ä¸­æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨è·¯ç”±ï¼Œä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼šapp.<method>(pathï¼Œcallback)
```

```js
var express = require('express');

//åˆ›å»ºåº”ç”¨
var app = express();

//åˆ›å»ºè·¯ç”±è§„åˆ™
app.get('/home',(req,res)=>{
    console.log('æœ‰äººè¯·æ±‚homeé¡µäº†');
    res.send('hello express server');
});
app.get('/',(req,res)=>{
    console.log('æœ‰äººè¯·æ±‚shoué¡µäº†');
    res.send('hello express server');
});

//åˆ›å»º post è·¯ç”±
app.post('/login',(req,res)=>{
    res.send('ç™»å½•æˆåŠŸ');
});

//åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚æ–¹æ³•
 app.get('/search',(req,res)=>{
     console.log('æœ‰äººè¯·æ±‚searché¡µäº†');
     res.send('hello express server');
 });

//åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚æ–¹æ³•
app.all('/search2', (req, res) => {
    res.send('1 ç§’é’Ÿä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç»“æœçº¦ 100,000,000 ä¸ª');
});

//è‡ªå®šä¹‰ 404 è·¯ç”± ,åº”è¯¥æ”¾åœ¨æœ€ä¸‹é¢,è·¯ç”±ä¼šä»ä¸Šåˆ°ä¸‹åŒ¹é…
 app.get('*',(req,res)=>{
     res.send('<h1>404 Not Found</h1>');
 }); 

// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000,()=>{
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})
```



- æ³¨æ„:éªŒè¯postçš„æ–¹æ³•,ç›®å‰å·²çŸ¥æœ‰`ajax` åŠ `è¡¨å•`,éªŒè¯htmlå¦‚ä¸‹

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h1>home</h1>
    <form action="http://localhost:3000/login" method="post">
        <input type="submit">
    </form>
</body>
</html>
```



#### 9.2.3 è·å–è¯·æ±‚å‚æ•°

express æ¡†æ¶å°è£…äº†ä¸€äº› API æ¥æ–¹ä¾¿è·å–è¯·æ±‚æŠ¥æ–‡ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”å…¼å®¹åŸç”Ÿ HTTP æ¨¡å—çš„è·å–æ–¹å¼

```js
app.get('/login',(req,res)=>{
    console.log('æœ‰äººè¯·æ±‚loginé¡µäº†');
    // 1. è·å–æŠ¥æ–‡çš„æ–¹å¼ä¸åŸç”Ÿ HTTP è·å–æ–¹å¼æ˜¯å…¼å®¹çš„ ã€åŸç”Ÿæ“ä½œã€‘
    console.log(req.method);//GET
    console.log(req.url);// //login?username=sadasd
    console.log(req.httpVersion);// 1.1
    console.log(req.headers);

    // 2. express ç‹¬æœ‰çš„è·å–æŠ¥æ–‡çš„æ–¹å¼ ã€expressç‹¬æœ‰æ“ä½œã€‘
    //è·å–æŸ¥è¯¢å­—ç¬¦ä¸²
    console.log(req.path)//ã€ç›¸å¯¹é‡è¦ã€ /login ç­‰ä»·äºï¼šrequire('url').parse(request.url).pathname
    console.log(req.query)//ã€ç›¸å¯¹é‡è¦ã€{ username: 'sadasd' } ç­‰ä»·äºï¼šrequire('url').parse(request.urlï¼Œtrue).query
    console.log(req.params.username)//ã€ç›¸å¯¹é‡è¦ã€{ username: 'sadasd' }
    // è·å–æŒ‡å®šçš„è¯·æ±‚å¤´
    console.log(req.get('host'));
    res.send('è¯·æ±‚æŠ¥æ–‡çš„è·å–');
});
```



#### 9.2.4 è·å–è·¯ç”±å‚æ•°

eg:https://npcitem.jd.hk/10051796795661.html , `å–å¾—10051796795661å‚æ•°`

```js
var express = require('express');
//åˆ›å»ºåº”ç”¨
var app = express();
// eg: https://npcitem.jd.hk/10051796795661.html
//åˆ›å»ºè·¯ç”±è§„åˆ™
app.get('/:id.html',(req,res)=>{
    console.log('æœ‰äººè¯·æ±‚homeé¡µäº†');
    res.send('å•†å“è¯¦æƒ…, å•†å“ id ä¸º'+req.params.id);
});

// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000,()=>{
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})

```



`expressè·¯ç”±å‚æ•°ç»ƒä¹ .js`

```js
//å¯¼å…¥express
const express = require("express");
//å¯¼å…¥jsonæ–‡ä»¶
const { list } = require("./lijun.json");

//åˆ›å»ºåº”ç”¨å¯¹è±¡
const app = express();

//åˆ›å»ºè·¯ç”±
app.get("/login/:id.html", (req, res) => {
  //è·å–è·¯ç”±å‚æ•°
  let { id } = req.params;
  let result = list.find((item) => {
    if (item.id === Number(id)) {
      return true;
    }
  });
  console.log(result);

  res.end(`<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Document</title>
          </head>
          <body>
              <h3>${result.id}</h3>
              <h4>${result.name}</h4>
              <img src="${result.image_url}" alt="" />
              <p>${result.description}</p>
          </body>
          </html>`);
});

//ç›‘å¬ç«¯å£

app.listen(3000, () => {
  console.log("ç«¯å£å¯åŠ¨æˆåŠŸ...");
});
```



#### 9.2.5 å“åº”è®¾ç½®å‚æ•°

expressæ¡†æ¶å°è£…äº†ä¸€äº›APIæ¥æ–¹ä¾¿ç»™å®¢æˆ·ç«¯å“åº”æ•°æ®ï¼Œå¹¶ä¸”å…¼å®¹åŸç”ŸHTTPæ¨¡å—çš„è·å–æ–¹å¼

```js
//è·å–è¯·æ±‚çš„è·¯ç”±è§„åˆ™
app.get("/response", (req, res) => {
//1. express ä¸­è®¾ç½®å“åº”çš„æ–¹å¼å…¼å®¹ HTTP æ¨¡å—çš„æ–¹å¼
res.statusCode = 404;
res.statusMessage = 'xxx';
res.setHeader('abc','xyz');
res.write('å“åº”ä½“');
res.end('xxx');
    
//2. express çš„å“åº”æ–¹æ³•
res.status(500); //è®¾ç½®å“åº”çŠ¶æ€ç 
res.set('xxx','yyy');//è®¾ç½®å“åº”å¤´
res.send('ä¸­æ–‡å“åº”ä¸ä¹±ç ');//è®¾ç½®å“åº”ä½“
//è¿è´¯æ“ä½œ
res.status(404).set('xxx','yyy').send('ä½ å¥½æœ‹å‹')
    
//3. å…¶ä»–å“åº”
res.redirect('http://atguigu.com')//é‡å®šå‘
res.download('./package.json');//ä¸‹è½½å“åº”
res.json();//å“åº” JSON
res.sendFile(__dirname + '/home.html') //å“åº”æ–‡ä»¶å†…å®¹ åªæ¥å—ç»å¯¹è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ã€‚
});
```



### 9.3 express ä¸­é—´ä»¶

ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰æœ¬è´¨æ˜¯ä¸€ä¸ª`å›è°ƒå‡½æ•°`
ä¸­é—´ä»¶å‡½æ•° å¯ä»¥åƒè·¯ç”±å›è°ƒä¸€æ ·è®¿é—® `è¯·æ±‚å¯¹è±¡ï¼ˆrequestï¼‰` ï¼Œ`å“åº”å¯¹è±¡ï¼ˆresponseï¼‰`
`ä¸­é—´ä»¶çš„ä½œç”¨` å°±æ˜¯` ä½¿ç”¨å‡½æ•°å°è£…å…¬å…±æ“ä½œï¼Œç®€åŒ–ä»£ç `



#### 9.3.1 å®šä¹‰å…¨å±€ä¸­é—´ä»¶

`æ¯ä¸€ä¸ªè¯·æ±‚ `åˆ°è¾¾æœåŠ¡ç«¯ä¹‹å `éƒ½ä¼šæ‰§è¡Œå…¨å±€ä¸­é—´ä»¶å‡½æ•°

```js
let recordMiddleware = function(request,response,next){
//å®ç°åŠŸèƒ½ä»£ç 
//.....
//æ‰§è¡Œnextå‡½æ•°(å½“å¦‚æœå¸Œæœ›æ‰§è¡Œå®Œä¸­é—´ä»¶å‡½æ•°ä¹‹åï¼Œä»ç„¶ç»§ç»­æ‰§è¡Œè·¯ç”±ä¸­çš„å›è°ƒå‡½æ•°ï¼Œå¿…é¡»è°ƒç”¨next)
next();
}
#åº”ç”¨ä¸­é—´ä»¶
app.use(recordMiddleware);
```

![image-20241103192204050](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103192204050.png)

#### 9.3.2 å¤šä¸ªå…¨å±€ä¸­é—´ä»¶

```js
app.use(function (request, response, next) {
console.log('å®šä¹‰ç¬¬ä¸€ä¸ªä¸­é—´ä»¶');
next();
})
app.use(function (request, response, next) {
console.log('å®šä¹‰ç¬¬äºŒä¸ªä¸­é—´ä»¶');
next();
})

```



#### 9.3.4 å®šä¹‰è·¯ç”±ä¸­é—´ä»¶

å¦‚æœ `åªéœ€è¦å¯¹æŸä¸€äº›è·¯ç”±è¿›è¡ŒåŠŸèƒ½å°è£…` ï¼Œåˆ™å°±éœ€è¦è·¯ç”±ä¸­é—´ä»¶

```js
//å¼•å…¥expressæ¡†æ¶
const express = require('express');
//åˆ›å»ºæœåŠ¡å¯¹è±¡
const app = express();
//é™æ€èµ„æºä¸­é—´ä»¶çš„è®¾ç½®ï¼Œå°†å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„publicç›®å½•ä½œä¸ºç½‘ç«™çš„æ ¹ç›®å½•
app.use(express.static('./public')); //å½“ç„¶è¿™ä¸ªç›®å½•ä¸­éƒ½æ˜¯ä¸€äº›é™æ€èµ„æº
//å¦‚æœè®¿é—®çš„å†…å®¹ç»å¸¸å˜åŒ–ï¼Œè¿˜æ˜¯éœ€è¦è®¾ç½®è·¯ç”±
//ä½†æ˜¯ï¼Œåœ¨è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœpublicç›®å½•ä¸‹æœ‰index.htmlæ–‡ä»¶ï¼Œå•ç‹¬ä¹Ÿæœ‰index.htmlçš„è·¯ç”±ï¼Œ
//åˆ™è°ä¹¦å†™åœ¨å‰ï¼Œä¼˜å…ˆæ‰§è¡Œè°
app.get('/index.html',(request,response)=>{
respsonse.send('é¦–é¡µ');
});
//ç›‘å¬ç«¯å£
app.listen(3000,()=>{
console.log('3000 ç«¯å£å¯åŠ¨....');
});

```

`æ³¨æ„äº‹é¡¹:`

1. `index.html æ–‡ä»¶ä¸ºé»˜è®¤æ‰“å¼€çš„èµ„æº`
2. `å¦‚æœé™æ€èµ„æºä¸è·¯ç”±è§„åˆ™åŒæ—¶åŒ¹é…ï¼Œè°å…ˆåŒ¹é…è°å°±å“åº”`
3. `è·¯ç”±å“åº”åŠ¨æ€èµ„æºï¼Œé™æ€èµ„æºä¸­é—´ä»¶å“åº”é™æ€èµ„æº`



### 9.5 è·å–è¯·æ±‚ä½“æ•°æ®body-parser

`è·å–è¯·æ±‚ä½“æ•°æ® body-parser`

- å®‰è£…&å¯¼åŒ…

```js
npm i body-parser
const bodyParser = require('body-parser');
```

- è·å–ä¸­é—´ä»¶å‡½æ•°

```js
//å¤„ç† querystring æ ¼å¼çš„è¯·æ±‚ä½“
let urlParser = bodyParser.urlencoded({extended:false});
//å¤„ç† JSON æ ¼å¼çš„è¯·æ±‚ä½“
let jsonParser = bodyParser.json();
```

- è®¾ç½®è·¯ç”±ä¸­é—´ä»¶ï¼Œç„¶åä½¿ç”¨ `request.body` æ¥è·å–è¯·æ±‚ä½“æ•°æ®

```js
app.post('/login', urlParser, (request,response)=>{
//è·å–è¯·æ±‚ä½“æ•°æ®
//console.log(request.body);
//ç”¨æˆ·å
console.log(request.body.username);
//å¯†ç 
console.log(request.body.userpass);
response.send('è·å–è¯·æ±‚ä½“æ•°æ®');
});

```



### 9.6 å›¾ç‰‡é˜²ç›—é“¾

```js
var express = require('express');
//åˆ›å»ºåº”ç”¨
var app = express();
//å£°æ˜ä¸­é—´å‡½æ•°
function recordMiddleware(req,res,next){
    var referer = req.get('referer');// è·å–æŒ‡å®šçš„è¯·æ±‚å¤´
    if (referer) {
        var url = new URL(referer);
        var hostname = url.hostname;
        console.log(hostname);
        console.log(hostname !== 'localhost');
        if (hostname !== 'localhost') {
            console.log('f')
            res.status(404).send(`<h1>404 Not found</h1>`);
            return;
        }
    }
    console.log('ç»§ç»­æ‰§è¡Œ')
    next();

}
app.use(recordMiddleware);
app.use(express.static(__dirname+'/public')); //è¦æ”¾åœ¨åé¢

// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000,()=>{
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})

```



### 9.7 Router

#### 9.7.2 Router ä»‹ç»

express ä¸­çš„ Router æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¸­é—´ä»¶å’Œè·¯ç”±ç³»ç»Ÿï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå°å‹çš„` app å¯¹è±¡`ã€‚å¯¹è·¯ç”±è¿›è¡Œæ¨¡å—åŒ–ï¼Œæ›´å¥½çš„ç®¡ç†è·¯ç”±



#### 9.7.1 Router ä½¿ç”¨

- åˆ›å»ºç‹¬ç«‹çš„ JS æ–‡ä»¶ï¼ˆhomeRouter.jsï¼‰

```js
//1. å¯¼å…¥ express
const express = require('express');
//2. åˆ›å»ºè·¯ç”±å™¨å¯¹è±¡
const router = express.Router();
//3. åœ¨ router å¯¹è±¡èº«ä¸Šæ·»åŠ è·¯ç”±
router.get('/', (req, res) => {
res.send('é¦–é¡µ');
})
router.get('/cart', (req, res) => {
res.send('è´­ç‰©è½¦');
});
//4. æš´éœ²
module.exports = router;

```

*ä¸»æ–‡ä»¶

```js
const express = require('express');
const app = express();
//5.å¼•å…¥å­è·¯ç”±æ–‡ä»¶
const homeRouter = require('./routes/homeRouter');
//6.è®¾ç½®å’Œä½¿ç”¨ä¸­é—´ä»¶
app.use(homeRouter);
//app.use('/', indexRouter);//è·¯ç”±(é»˜è®¤)
//app.use('/users', usersRouter);//è·¯ç”±å‰ç¼€
app.listen(3000,()=>{
console.log('3000 ç«¯å£å¯åŠ¨....');
})

```



### 9.8 EJSæ¨¡æ¿å¼•æ“

æ¨¡æ¿å¼•æ“æ˜¯åˆ†ç¦» `ç”¨æˆ·ç•Œé¢å’Œä¸šåŠ¡æ•°æ®` çš„ä¸€ç§æŠ€æœ¯ (åˆ†ç¦»`html`å’Œ`js`)



#### 9.8.1 ä»€ä¹ˆæ˜¯ EJS

EJS æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ Javascript çš„æ¨¡æ¿å¼•æ“
å®˜ç½‘: `https://ejs.co/`
ä¸­æ–‡ç«™ï¼š `https://ejs.bootcss.com/`

```js
//1.å®‰è£…ejs
//2.å¯¼å…¥ejs
var ejs = require('ejs');
var fs = require('fs');
//å­—ç¬¦ä¸²
var china = 'ä¸­å›½';
var weather = 'å¤§å¤ªé˜³';

var demo = fs.readFileSync('./13_æ¨¡æ¿å¼•æ“/demo.html','utf-8');
// //ä½¿ç”¨ejsæ¸²æŸ“
// // var result = ejs.render('æˆ‘çˆ±ä½  <%= china %>',{china:china});
// // var result = ejs.render('æˆ‘çˆ±ä½  <%= china %>',{china});
var result = ejs.render(demo,{china,weather});
console.log(result);

```



#### 9.8.2 EJSå¸¸ç”¨è¯­æ³•

```js
æ‰§è¡ŒJSä»£ç 
<% code %>
è¾“å‡ºè½¬ä¹‰çš„æ•°æ®åˆ°æ¨¡æ¿ä¸Š
<%= code %>
è¾“å‡ºéè½¬ä¹‰çš„æ•°æ®åˆ°æ¨¡æ¿ä¸Š
<%- code %>
```



#### 9.8.3 expressä¸­ä½¿ç”¨EJS

```js
npm i ejs
```

- home.ejs

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
 <h1>æˆ‘çˆ±ä½  <%= china %></h1>
<%=weather%>
</body>
</html>
```

- 15_æ¨¡æ¿å¼•æ“_expressä¸­ä½¿ç”¨ejs.js

```js
var express = require('express');
var path = require('path');
var app = express();
var china='ä¸­å›½';
var weather = 'å¤§å¤ªé˜³';
//1.è®¾ç½®æ¨¡æ¿å¼•æ“
app.set('view engine','ejs');
//2.è®¾ç½®æ¨¡æ¿æ–‡ä»¶å­˜æ”¾ä½ç½®
app.set('views',path.resolve(__dirname,'./13_æ¨¡æ¿å¼•æ“'));
app.get('/home2',(req,res)=>{
    res.setHeader("Content-Type","text/html;charset=utf-8")
    //3.renderå“åº”,ç›´æ¥æ¸²æŸ“åˆ°é¡µé¢è¿”å›
    res.render('home',{china,weather});
})

// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000,()=>{
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})

```



#### 9.8.4 express-generator

[express-generatorä¸­æ–‡å®˜ç½‘](https://www.expressjs.com.cn/starter/generator.html)

```js
npm install -g express-generator å…¨å±€å®‰è£…å‘½ä»¤
express -h æŸ¥çœ‹å¸®åŠ©
express -e <ç›®å½•å> æˆ– --view =ejs <ç›®å½•å> å½“å‰ç›®å½•æˆ–æŒ‡å®šç›®å½•åˆå§‹åŒ–å¯ç›´æ¥åˆ›å»º)
express i å®‰è£…ä¾èµ–
npm start å¯åŠ¨
```



#### 9.8.5 æ–‡ä»¶ä¸Šä¼ 

```js
<form method="post" action="./fileDeal" enctype="multipart/form-data">
        è¯·è¾“å…¥å§“å:<input type="text" name="username">
        è¯·ä¸Šä¼ æ–‡ä»¶:<input type="file" name="myfile">
        <button>æäº¤</button>
    </form>

```



#### 9.8.6 æ–‡ä»¶å¤„ç†

- å¼•å…¥åŒ…`npm i formidable@2.1.2` (é«˜ç‰ˆæœ¬ä¼šæŠ¥é”™)
- [formidable](https://www.npmjs.com/package/formidable)

![image-20241103192718606](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103192718606.png)

```js
var express = require('express');
var formidable = require('formidable');
var path = require('path');
var router = express.Router();
router.post('/fileDeal', (req, res) => {
    const form = formidable({
        //è®¾ç½®æ–‡ä»¶ä¿å­˜è·¯å¾„
        uploadDir: path.resolve(__dirname , './public'),
        //ä¿æŒæ–‡ä»¶åç¼€
        keepExtensions: true

    });

    form.parse(req, (err, fields, files) => {
        if (err) {
            next(err);
            return;
        }
        // console.log(fields)//å±æ€§é›†åˆ
        // console.log(files)//æ–‡ä»¶é›†åˆ

        //æœåŠ¡å™¨ä¿å­˜è¯¥å›¾ç‰‡çš„è®¿é—® URL
        // /images/8ad3d5e36012212ba7642c000.jpg
        // let url = '/public/' + files.myfile.newFilename;// å°†æ¥å°†æ­¤æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­
        let url = files.myfile.newFilename;// å°†æ¥å°†æ­¤æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­
        // res.json({fields, files});
        res.end(url);
    });
})

```



## 10. Mongodb

### 10.1 ä»‹ç»

MongoDB æ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“(`å¹¶ä¸æ˜¯å•çº¯çš„å†…å­˜æ•°æ®åº“`)ï¼Œå®˜æ–¹åœ°å€ `https://www.mongodb.com/`
æ“ä½œè¯­æ³•ä¸ JavaScript ç±»ä¼¼ï¼Œå®¹æ˜“ä¸Šæ‰‹ï¼Œå­¦ä¹ æˆæœ¬ä½

Mongodb ä¸­æœ‰ä¸‰ä¸ªé‡è¦æ¦‚å¿µéœ€è¦æŒæ¡
æ•°æ®åº“ï¼ˆdatabaseï¼‰ æ•°æ®åº“æ˜¯ä¸€ä¸ªæ•°æ®ä»“åº“ï¼Œæ•°æ®åº“æœåŠ¡ä¸‹å¯ä»¥åˆ›å»ºå¾ˆå¤šæ•°æ®åº“ï¼Œæ•°æ®åº“ä¸­å¯ä»¥å­˜æ”¾å¾ˆå¤šé›†åˆ
é›†åˆï¼ˆcollectionï¼‰ é›†åˆç±»ä¼¼äº JS ä¸­çš„æ•°ç»„ï¼Œåœ¨é›†åˆä¸­å¯ä»¥å­˜æ”¾å¾ˆå¤šæ–‡æ¡£
æ–‡æ¡£ï¼ˆdocumentï¼‰ æ–‡æ¡£æ˜¯æ•°æ®åº“ä¸­çš„æœ€å°å•ä½ï¼Œç±»ä¼¼äº JS ä¸­çš„å¯¹è±¡

![image-20241103192757791](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103192757791.png)



### 10.2 ä¸‹è½½ä¸å¯åŠ¨

ä¸‹è½½åœ°å€ï¼š https://www.mongodb.com/try/download/community
å»ºè®®é€‰æ‹© zip ç±»å‹ï¼Œ é€šç”¨æ€§æ›´å¼ºé…ç½®æ­¥éª¤å¦‚ä¸‹:

1. å°†å‹ç¼©åŒ…ç§»åŠ¨åˆ° C:\Program Files ä¸‹ï¼Œç„¶åè§£å‹
2. åˆ›å»º C:\data\db ç›®å½•ï¼Œmongodb ä¼šå°†æ•°æ®é»˜è®¤ä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹
3. ä»¥ mongodb ä¸­ bin ç›®å½•ä½œä¸ºå·¥ä½œç›®å½•ï¼Œå¯åŠ¨å‘½ä»¤è¡Œ
4. è¿è¡Œå‘½ä»¤ mongod
5. è®¿é—®http://localhost:27017 æµ‹è¯• æˆ–`å¯åŠ¨å®¢æˆ·ç«¯å·¥å…·mongo.exeå·¥å…·`

è‡ªå®šä¹‰é…ç½®å¯åŠ¨:

1. æ–°å»ºdata log etc 3ä¸ªç›®å½•
2. åœ¨etcä¸‹æ–°å»ºmongodb.confé…ç½®æ–‡ä»¶
3. `# dbå­˜æ”¾çš„ç›®å½•`dbpath=D:\mongodb-windows-x86_64-5.0.24\mongodb-win32-x86_64-windows-5.0.24\data `# åå°å¯åŠ¨éœ€è¦é…ç½®æ—¥å¿—è¾“å‡º` logpath=D:\mongodb-windows-x86_64-5.0.24\mongodb-win32-x86_64-windows-5.0.24\log\mongodb.log
4. è¿è¡Œå‘½ä»¤å¯åŠ¨ `mongod --config D:\mongodb-windows-x86_64-5.0.24\mongodb-win32-x86_64-windows-5.0.24\etc\mongodb.conf`

[linunxå®‰è£…å‚è€ƒ](https://www.cnblogs.com/gbc223/articles/17167483.html)

![image-20241103193117758](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193117758.png)

![image-20241103193123818](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193123818.png)



### 10.3 å‘½ä»¤è¡Œäº¤äº’

- æ•°æ®åº“æ“ä½œ

æ˜¾ç¤ºæ‰€æœ‰çš„æ•°æ®åº“
`show dbs`
åˆ‡æ¢åˆ°æŒ‡å®šçš„æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“(åˆšåˆ›å»ºä¸ä¼šæ˜¾ç¤º,åªæœ‰åŠ å…¥æ•°æ®,æ‰ä¼šåˆ›å»º)
`use æ•°æ®åº“å`
æ˜¾ç¤ºå½“å‰æ‰€åœ¨çš„æ•°æ®åº“
`db`
åˆ é™¤å½“å‰æ•°æ®åº“
`use åº“å`
`db.dropDatabase()`

- é›†åˆæ“ä½œ

åˆ›å»ºé›†åˆ
`db.createCollection('é›†åˆåç§°')`
æ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰é›†åˆ
`show collections`
åˆ é™¤æŸä¸ªé›†åˆ
`db.é›†åˆå.drop()`
é‡å‘½åé›†åˆ
`db.é›†åˆå.renameCollection('newName')`

- æ–‡æ¡£æ“ä½œ

æ’å…¥æ–‡æ¡£
`db.é›†åˆå.insert(æ–‡æ¡£å¯¹è±¡);`
æŸ¥è¯¢æ–‡æ¡£
`db.é›†åˆå.find(æŸ¥è¯¢æ¡ä»¶)`
_id æ˜¯ mongodb è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€ç¼–å·ï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†æ–‡æ¡£
æ›´æ–°æ–‡æ¡£

`db.é›†åˆå.update(æŸ¥è¯¢æ¡ä»¶,æ–°çš„æ–‡æ¡£)` é»˜è®¤å…¨éƒ¨å­å¼¹æ›´æ–°

`db.é›†åˆå.update({name:'å¼ ä¸‰'},{$set:{age:19}})` æŒ‡å®šå­—æ®µæ›´æ–°

åˆ é™¤æ–‡æ¡£

`db.é›†åˆå.remove(æŸ¥è¯¢æ¡ä»¶)`

update æ–¹æ³•é»˜è®¤åªä¼šæ›´æ–°ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„ç¬¬ä¸€æ¡æ–‡æ¡£ã€‚è¿™æ˜¯å› ä¸ºåœ¨è¿›è¡Œæ›´æ–°æ“ä½œæ—¶ï¼ŒMongoDBé»˜è®¤åªä¼šæ›´æ–°åŒ¹é…çš„ç¬¬ä¸€æ¡æ–‡æ¡£ï¼Œé™¤éä½ æ˜¾å¼æŒ‡å®š multi: true é€‰é¡¹ï¼Œè¿™æ ·æ‰ä¼šæ›´æ–°æ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ update æ–¹æ³•æ¥æ›´æ–°æ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£ï¼š
`db.é›†åˆå.update(æŸ¥è¯¢æ¡ä»¶, æ›´æ–°æ“ä½œ, { multi: true })`

![image-20241103193312838](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193312838.png)

![image-20241103193318964](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193318964.png)



### 10.4 mongoose

Mongoose æ˜¯ä¸€ä¸ªå¯¹è±¡æ–‡æ¡£æ¨¡å‹åº“ï¼Œå®˜ç½‘ `http://www.mongoosejs.net/`
æ–¹ä¾¿ä½¿ç”¨ä»£ç æ“ä½œ mongodb æ•°æ®åº“
`npm i mongoose@5.13.15`



#### 10.4.1 åˆæ­¥ä½¿ç”¨

```js
//1. å®‰è£… mongoose
//2. å¯¼å…¥ mongoose
const mongoose = require('mongoose');
//è®¾ç½® strictQuery ä¸º true
mongoose.set('strictQuery', true);
//3. è¿æ¥ mongodb æœåŠ¡                        æ•°æ®åº“çš„åç§°,æ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»º
mongoose.connect('mongodb://127.0.0.1:27017/bilibili');

//4. è®¾ç½®å›è°ƒ
// è®¾ç½®è¿æ¥æˆåŠŸçš„å›è°ƒ  once ä¸€æ¬¡   äº‹ä»¶å›è°ƒå‡½æ•°åªæ‰§è¡Œä¸€æ¬¡
mongoose.connection.once('open', () => {
        console.log('è¿æ¥æˆåŠŸ');
        //5. åˆ›å»ºæ–‡æ¡£çš„ç»“æ„å¯¹è±¡
        //è®¾ç½®é›†åˆä¸­æ–‡æ¡£çš„å±æ€§ä»¥åŠå±æ€§å€¼çš„ç±»å‹
        let BookSchema = new mongoose.Schema({
            name: String,
            author: String,
            price: Number
        });
        //6. åˆ›å»ºæ¨¡å‹å¯¹è±¡  å¯¹æ–‡æ¡£æ“ä½œçš„å°è£…å¯¹è±¡
        let BookModel = mongoose.model('book', BookSchema);
        //7. æ–°å¢æ–‡æ¡£
        //7. æ–°å¢
        BookModel.create({
            name: 'è¥¿æ¸¸è®°',
            author: 'å´æ‰¿æ©',
            price: 19.9
        }, (err, data) => {
            //åˆ¤æ–­æ˜¯å¦æœ‰é”™è¯¯
            if (err) {
                console.log(err);
                return;
            }
            //å¦‚æœæ²¡æœ‰å‡ºé”™, åˆ™è¾“å‡ºæ’å…¥åçš„æ–‡æ¡£å¯¹è±¡
            console.log(data);
            //8. å…³é—­æ•°æ®åº“è¿æ¥ (é¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­, ä¸ä¼šæ·»åŠ è¯¥ä»£ç )
            mongoose.disconnect();
        });
    }
);

// è®¾ç½®è¿æ¥é”™è¯¯çš„å›è°ƒ
mongoose.connection.on('error', () => {
    console.log('è¿æ¥å¤±è´¥');
});

//è®¾ç½®è¿æ¥å…³é—­çš„å›è°ƒ
mongoose.connection.on('close', () => {
    console.log('è¿æ¥å…³é—­');
});

// å…³é—­ mongodb çš„è¿æ¥
// setTimeout(() => {
//   mongoose.disconnect();
// }, 2000)

```



#### 10.4.2 å­—æ®µç±»å‹

![image-20241103193347434](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193347434.png)



#### 10.4.3 å­—æ®µå€¼éªŒè¯

Mongoose æœ‰ä¸€äº›å†…å»ºéªŒè¯å™¨ï¼Œå¯ä»¥å¯¹å­—æ®µå€¼è¿›è¡ŒéªŒè¯

- å¿…å¡«é¡¹

```js
title: {
type: String,
required: true // è®¾ç½®å¿…å¡«é¡¹
},
```

- é»˜è®¤å€¼

```js
author: {
type: String,
default: 'åŒ¿å' //é»˜è®¤å€¼
},
```

- æšä¸¾å€¼

```js
gender: {
type: String,
enum: ['ç”·','å¥³'] //è®¾ç½®çš„å€¼å¿…é¡»æ˜¯æ•°ç»„ä¸­çš„
},
```

- å”¯ä¸€å€¼

```js
username: {
type: String,
unique: true
},
## unique éœ€è¦ é‡å»ºé›†åˆ æ‰èƒ½æœ‰æ•ˆæœ
```

```js
 let BookSchema = new mongoose.Schema({
            name: {
                type: String,
                required: true, // è¡¨æ˜è¯¥å±æ€§å¿…é¡»ä¸ä¸ºç©º
                unique: true// è®¾ç½®ä¸ºç‹¬ä¸€æ— äºŒçš„
            },
            author: {
                type: String,
                default: 'åŒ¿å'
            },
            //ç±»å‹
            style: {
                type: String,
                //æšä¸¾
                enum: ['è¨€æƒ…','åŸå¸‚','å¿—æ€ª','ææ€–']
            },
            price: Number
        });
```



#### 10.4.4 CURD

æ•°æ®åº“çš„åŸºæœ¬æ“ä½œåŒ…æ‹¬å››ä¸ªï¼Œ`å¢åŠ ï¼ˆcreateï¼‰ï¼Œåˆ é™¤ï¼ˆdeleteï¼‰ï¼Œä¿®æ”¹ï¼ˆupdateï¼‰ï¼ŒæŸ¥ï¼ˆreadï¼‰`

- å¢åŠ 

```js
æ’å…¥ä¸€æ¡
SongModel.create({
title:'ç»™æˆ‘ä¸€é¦–æ­Œçš„æ—¶é—´',
author: 'Jay'
}, function(err, data){
//é”™è¯¯
console.log(err);
//æ’å…¥åçš„æ•°æ®å¯¹è±¡
console.log(data);
});

æ‰¹é‡æ’å…¥
PhoneModel.insertMany([
{
brand:'åä¸º',
color:'ç°è‰²',
price:2399,
tags:['ç”µé‡å¤§','å±å¹•å¤§','ä¿¡å·å¥½']
},
{
brand:'å°ç±³',
color:'ç™½è‰²',
price:2099,
tags:['ç”µé‡å¤§','å±å¹•å¤§','ä¿¡å·å¥½']
}
],(err,data)=>{
if(err) throw err;
console.log('å†™å…¥æˆåŠŸ');
mongoose.connection.close();
})

```

- åˆ é™¤

```js
åˆ é™¤ä¸€æ¡æ•°æ®
SongModel.deleteOne({_id:'5dd65f32be6401035cb5b1ed'}, function(err){
if(err) throw err;
console.log('åˆ é™¤æˆåŠŸ');
mongoose.connection.close();
});

æ‰¹é‡åˆ é™¤
SongModel.deleteMany({author:'Jay'}, function(err){
if(err) throw err;
console.log('åˆ é™¤æˆåŠŸ');
mongoose.connection.close();
});

```

- æ›´æ–°

```js
æ›´æ–°ä¸€æ¡æ•°æ®
SongModel.updateOne({author: 'JJ Lin'}, {author: 'æ—ä¿Šæ°'}, function (err) {
if(err) throw err;
mongoose.connection.close();
});


æ‰¹é‡æ›´æ–°æ•°æ®
SongModel.updateMany({author: 'Leehom Wang'}, {author: 'ç‹åŠ›å®'}, function (err) {
if(err) throw err;
mongoose.connection.close();
});

```

- æŸ¥è¯¢

```js
æŸ¥è¯¢ä¸€æ¡æ•°æ®
SongModel.findOne({author: 'ç‹åŠ›å®'}, function(err, data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});
//æ ¹æ® id æŸ¥è¯¢æ•°æ®
SongModel.findById('5dd662b5381fc316b44ce167',function(err, data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});

æ‰¹é‡æŸ¥è¯¢æ•°æ®
//ä¸åŠ æ¡ä»¶æŸ¥è¯¢
SongModel.find(function(err, data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});
//åŠ æ¡ä»¶æŸ¥è¯¢
SongModel.find({author: 'ç‹åŠ›å®'}, function(err, data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});

```



#### 10.4.5 æ¡ä»¶æ§åˆ¶

- è¿ç®—ç¬¦

åœ¨ mongodb ä¸èƒ½ > < >= <= !== ç­‰è¿ç®—ç¬¦ï¼Œéœ€è¦ä½¿ç”¨æ›¿ä»£ç¬¦å·
`> ä½¿ç”¨ $gt`
`< ä½¿ç”¨ $lt`
`>= ä½¿ç”¨ $gte`
`<= ä½¿ç”¨ $lte`

`!== ä½¿ç”¨ $ne`
db.students.find({id:{$gt:3}}); idå·æ¯”3å¤§çš„æ‰€æœ‰çš„è®°å½•

- é€»è¾‘è¿ç®—

$or é€»è¾‘æˆ–çš„æƒ…å†µ
db.students.find({KaTeX parse error: Expected 'EOF', got '}' at position 23: â€¦e:18},{age:24}]}Ì²); and é€»è¾‘ä¸çš„æƒ…å†µ`db.students.find({$and: [{age: {$lt:20}}, {age: {$gt: 15}}]});æ­£åˆ™åŒ¹é…æ¡ä»¶ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ JS çš„æ­£åˆ™è¯­æ³•ï¼Œé€šè¿‡æ­£åˆ™å¯ä»¥è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢`db.students.find({name:/imissyou/});



#### 10.4.6 ä¸ªæ€§åŒ–è¯»å–

- å­—æ®µç­›é€‰

```js
//0:ä¸è¦çš„å­—æ®µ
//1:è¦çš„å­—æ®µ
SongModel.find().select({_id:0,title:1}).exec(function(err,data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});

```

- æ•°æ®æ’åº

```js
//sort æ’åº
//1:å‡åº
//-1:å€’åº
SongModel.find().sort({hot:1}).exec(function(err,data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});

```

- æ•°æ®æˆªå–

```js
//skip è·³è¿‡ limit é™å®š
SongModel.find().skip(10).limit(10).exec(function(err,data){
if(err) throw err;
console.log(data);
mongoose.connection.close();
});

```



#### 10.4.7 å›¾å½¢åŒ–ç®¡ç†å·¥å…·

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å›¾å½¢åŒ–çš„ç®¡ç†å·¥å…·æ¥å¯¹ Mongodb è¿›è¡Œäº¤äº’ï¼Œè¿™é‡Œæ¼”ç¤ºä¸¤ä¸ªå›¾å½¢åŒ–å·¥å…·

Robo 3T å…è´¹ https://github.com/Studio3T/robomongo/releases
Navicat æ”¶è´¹ https://www.navicat.com.cn/



## 11. æ¥å£

### 11.1 RESTful API

RESTful API æ˜¯ä¸€ç§ç‰¹æ®Šé£æ ¼çš„æ¥å£ï¼Œä¸»è¦ç‰¹ç‚¹æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š

- URL ä¸­çš„è·¯å¾„è¡¨ç¤º èµ„æº ï¼Œè·¯å¾„ä¸­ä¸èƒ½æœ‰ `åŠ¨è¯` ï¼Œä¾‹å¦‚ `create , delete , update` ç­‰è¿™äº›éƒ½ä¸èƒ½æœ‰

- æ“ä½œèµ„æºè¦ä¸ HTTP `è¯·æ±‚æ–¹æ³•` å¯¹åº”
- æ“ä½œç»“æœè¦ä¸ HTTP `å“åº”çŠ¶æ€ç  `å¯¹åº”

![image-20241103193759132](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193759132.png)

æ‰©å±•é˜…è¯»ï¼š https://www.ruanyifeng.com/blog/2014/05/restful_api.html



### 11.2 json-server

json-server æœ¬èº«æ˜¯ä¸€ä¸ª JS ç¼–å†™çš„å·¥å…·åŒ…ï¼Œå¯ä»¥å¿«é€Ÿæ­å»º RESTful API æœåŠ¡

å®˜æ–¹åœ°å€: https://github.com/typicode/json-server

æ“ä½œæ­¥éª¤ï¼š

1. å…¨å±€å®‰è£… json-server
   `npm i -g json-server`
2. åˆ›å»º JSON æ–‡ä»¶ï¼ˆdb.jsonï¼‰ï¼Œç¼–å†™åŸºæœ¬ç»“æ„
3. ä»¥ JSON æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹ä½œä¸º`å·¥ä½œç›®å½• `ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
   `json-server --watch db.json`

```js
{
"song": [
{ "id": 1, "name": "å¹²æ¯", "singer": "äº”æœˆå¤©" },
{ "id": 2, "name": "å½“", "singer": "åŠ¨åŠ›ç«è½¦" },
{ "id": 3, "name": "ä¸èƒ½è¯´çš„ç§˜å¯†", "singer": "å‘¨æ°ä¼¦" }
]
}
```

## 12. ä¼šè¯æ§åˆ¶

æ‰€è°“ä¼šè¯æ§åˆ¶å°±æ˜¯ `å¯¹ä¼šè¯è¿›è¡Œæ§åˆ¶`
HTTP æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œå®ƒæ²¡æœ‰åŠæ³•åŒºåˆ†å¤šæ¬¡çš„è¯·æ±‚æ˜¯å¦æ¥è‡ªäºåŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œ `æ— æ³•åŒºåˆ†ç”¨æˆ·`
è€Œäº§å“ä¸­åˆå¤§é‡å­˜åœ¨çš„è¿™æ ·çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ `ä¼šè¯æ§åˆ¶` æ¥è§£å†³è¯¥é—®é¢˜.
å¸¸è§çš„ä¼šè¯æ§åˆ¶æŠ€æœ¯æœ‰ä¸‰ç§ï¼š

- cookie

- session

- token

  

### 12.1 cookie

- cookie æ˜¯ä»€ä¹ˆ

cookie æ˜¯ HTTP æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨æœ¬åœ°(`æµè§ˆå™¨`)çš„ä¸€å°å—æ•°æ®

`cookie æ˜¯ä¿å­˜åœ¨æµè§ˆå™¨ç«¯çš„ä¸€å°å—æ•°æ®`

`cookie æ˜¯æŒ‰ç…§åŸŸååˆ’åˆ†ä¿å­˜çš„`

æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šè‡ªåŠ¨å°† `å½“å‰åŸŸåä¸‹` å¯ç”¨çš„ cookie è®¾ç½®åœ¨è¯·æ±‚å¤´ä¸­ï¼Œç„¶åä¼ é€’ç»™æœåŠ¡å™¨

è¿™ä¸ªè¯·æ±‚å¤´çš„åå­—ä¹Ÿå« `cookie` ï¼Œæ‰€ä»¥å°†`cookie ç†è§£ä¸ºä¸€ä¸ª HTTP çš„è¯·æ±‚å¤´ä¹Ÿæ˜¯å¯ä»¥çš„`
`ä¸åŒæµè§ˆå™¨ä¸­çš„ cookie æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸å…±äº«`

![image-20241103193914456](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193914456.png)

![image-20241103193923319](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103193923319.png)

- expressä¸­ä½¿ç”¨cookie

- è®¾ç½®

```js
//è®¾ç½® cookie
app.get('/settt-cookie', (req, res) => {
    console.log('settt-cookie');
    // ä¸å¸¦æ—¶æ•ˆæ€§,ä¼šåœ¨æµè§ˆå™¨å…³é—­çš„æ—¶å€™,é”€æ¯
    res.cookie('username', 'wangwu');

    // å¸¦æ—¶æ•ˆæ€§
    res.cookie('email', '23123456@qq.com', {maxAge: 30 * 1000});
    res.end('hello express server');
});

```

- åˆ é™¤

```js
//åˆ é™¤cookie
app.get('/removee-cookie', (req, res) => {
    res.clearCookie('email');
    res.send('Cookieçš„åˆ é™¤');
});

```

- è·å–

```js
## npm -i cookie-parser
const cookieParser = require('cookie-parser');
//3. è®¾ç½® cookieParser ä¸­é—´ä»¶
app.use(cookieParser());


//è¯»å– cookie
app.get('/gettt-cookie', (req, res) => {
    console.log(req.cookies);
    res.send('Cookieçš„è¯»å–');
});

```



### 12.2 session

session æ˜¯ä¿å­˜åœ¨ `æœåŠ¡å™¨ç«¯çš„ä¸€å—å„¿æ•°æ®` ï¼Œä¿å­˜å½“å‰è®¿é—®ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯
å®ç°ä¼šè¯æ§åˆ¶ï¼Œå¯ä»¥è¯†åˆ«ç”¨æˆ·çš„èº«ä»½ï¼Œå¿«é€Ÿè·å–å½“å‰ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯

![image-20241103194002373](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194002373.png)

![image-20241103194009082](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194009082.png)

```js
var express = require('express');
//2. å¼•å…¥ express-session connect-mongo(å¦‚æœå­˜å…¥mongodbä¸­çš„è¯)
const session = require("express-session");
//2. å¼•å…¥ cookieParser åŒ…
const cookieParser = require('cookie-parser');
const MongoStore = require('connect-mongo');
var app = express();
app.use(cookieParser());
//3. è®¾ç½® session çš„ä¸­é—´ä»¶
app.use(session({
    name: 'sid', //è®¾ç½®cookieçš„nameï¼Œé»˜è®¤å€¼æ˜¯ï¼šconnect.sid
    secret: 'atguigu', //å‚ä¸åŠ å¯†çš„å­—ç¬¦ä¸²ï¼ˆåˆç§°ç­¾åï¼‰
    saveUninitialized: false, //æ˜¯å¦ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½è®¾ç½®ä¸€ä¸ªcookieç”¨æ¥å­˜å‚¨sessionçš„id
    resave: true, //æ˜¯å¦åœ¨æ¯æ¬¡è¯·æ±‚æ—¶é‡æ–°ä¿å­˜session,é‡æ–°å»¶é•¿sessionå­˜æ´»å‘¨æœŸ
    store: MongoStore.create({
        mongoUrl: 'mongodb://114.115.185.179:27017/bilibili' //æ•°æ®åº“çš„è¿æ¥é…ç½®
    }),
    cookie: {
        httpOnly: true, // å¼€å¯åå‰ç«¯æ— æ³•é€šè¿‡ JS æ“ä½œ
        maxAge: 1000 * 30 // è¿™ä¸€æ¡ æ˜¯æ§åˆ¶ sessionID çš„è¿‡æœŸæ—¶é—´çš„ï¼ï¼ï¼ (æµè§ˆå™¨å’ŒæœåŠ¡å™¨sessionéƒ½è¿‡æœŸ)
    },
}))

//åˆ›å»º session
app.get('/login', (req, res) => {
//è®¾ç½®session
    req.session.username = 'zhangsan';
    req.session.email = 'zhangsan@qq.com'
    res.send('ç™»å½•æˆåŠŸ');
})
//è·å– session
app.get('/home', (req, res) => {
    console.log('sessionçš„ä¿¡æ¯');
    console.log(req.session.username);
    console.log(req.cookies);
    if (req.session.username) {
        res.send(`ä½ å¥½ ${req.session.username}`);
    }else{
        res.send('ç™»å½• æ³¨å†Œ');
    }
})
//é”€æ¯ session
app.get('/logout', (req, res) => {
//é”€æ¯session
// res.send('è®¾ç½®session');
    req.session.destroy(() => {
        res.send('æˆåŠŸé€€å‡º');
    });
});
// ç›‘å¬ç«¯å£ å¯åŠ¨æœåŠ¡
app.listen(3000, () => {
    console.log('æœåŠ¡å·²ç»å¯åŠ¨, ç«¯å£ç›‘å¬ä¸º 3000...')
})

```



### 12.3 sessionå’Œcookieçš„åŒºåˆ«

cookie å’Œ session çš„åŒºåˆ«ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹

1. å­˜åœ¨çš„ä½ç½®

- cookieï¼šæµè§ˆå™¨ç«¯
- sessionï¼šæœåŠ¡ç«¯

â€‹	2.å®‰å…¨æ€§

- cookie æ˜¯ä»¥æ˜æ–‡çš„æ–¹å¼å­˜æ”¾åœ¨å®¢æˆ·ç«¯çš„ï¼Œå®‰å…¨æ€§ç›¸å¯¹è¾ƒä½
- session å­˜æ”¾äºæœåŠ¡å™¨ä¸­ï¼Œæ‰€ä»¥å®‰å…¨æ€§ `ç›¸å¯¹` è¾ƒå¥½

â€‹	3.ç½‘ç»œä¼ è¾“é‡

- cookie è®¾ç½®å†…å®¹è¿‡å¤šä¼šå¢å¤§æŠ¥æ–‡ä½“ç§¯ï¼Œ ä¼šå½±å“ä¼ è¾“æ•ˆç‡
- session æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ï¼Œåªæ˜¯é€šè¿‡ cookie ä¼ é€’ idï¼Œæ‰€ä»¥ä¸å½±å“ä¼ è¾“æ•ˆç‡

â€‹	4.å­˜å‚¨é™åˆ¶

- æµè§ˆå™¨é™åˆ¶å•ä¸ª cookie ä¿å­˜çš„æ•°æ®ä¸èƒ½è¶…è¿‡ `4K` ï¼Œä¸”å•ä¸ªåŸŸåä¸‹çš„å­˜å‚¨æ•°é‡ä¹Ÿæœ‰é™åˆ¶

- session æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸­ï¼Œæ‰€ä»¥æ²¡æœ‰è¿™äº›é™åˆ¶

  

### 12.4 token

`token` æ˜¯æœåŠ¡ç«¯ç”Ÿæˆå¹¶è¿”å›ç»™ HTTP å®¢æˆ·ç«¯çš„ä¸€ä¸²åŠ å¯†å­—ç¬¦ä¸²ï¼Œ` token` ä¸­ä¿å­˜ç€ `ç”¨æˆ·ä¿¡æ¯`
å®ç°ä¼šè¯æ§åˆ¶ï¼Œå¯ä»¥è¯†åˆ«ç”¨æˆ·çš„èº«ä»½ï¼Œä¸»è¦ç”¨äºç§»åŠ¨ç«¯ APP

![image-20241103194208293](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194208293.png)

![image-20241103194213689](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194213689.png)

- token çš„ç‰¹ç‚¹

1. æœåŠ¡ç«¯å‹åŠ›æ›´å°

   - æ•°æ®å­˜å‚¨åœ¨å®¢æˆ·ç«¯

2. ç›¸å¯¹æ›´å®‰å…¨

   - æ•°æ®åŠ å¯†
   - å¯ä»¥é¿å… CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

3. æ‰©å±•æ€§æ›´å¼º

   - `æœåŠ¡é—´å¯ä»¥å…±äº«`

   - å¢åŠ æœåŠ¡èŠ‚ç‚¹æ›´ç®€å•

     

#### 12.4.1 JWT

JWTï¼ˆJSON Web Token ï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆï¼Œå¯ç”¨äºåŸºäº token çš„èº«ä»½éªŒè¯ , JWT ä½¿`token`çš„ç”Ÿæˆä¸æ ¡éªŒæ›´è§„èŒƒ
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `jsonwebtoken` åŒ… æ¥æ“ä½œ token

**æ‰©å±•é˜…è¯»ï¼š**[ https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html](https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)

![image-20241103194248242](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194248242.png)

![image-20241103194253378](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194253378.png)

![image-20241103194259046](D:\Document\Note\0.Typoraèµ„æ–™\8.é¸¿è’™å¼€å‘\images\image-20241103194259046.png)



## 13. æ¨¡å—å·¥å…·ä½¿ç”¨

å‹ç¼©æ–‡ä»¶archiverï¼š https://blog.csdn.net/X1432564581/article/details/106398056/